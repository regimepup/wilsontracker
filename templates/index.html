<!DOCTYPE html>
<html>
<head>
    <title>Wilson Station Train Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script>
        async function fetchArrivals() {
            try {
                const response = await fetch("/arrivals_json");
                const data = await response.json();

                // Update last updated time
                document.getElementById("last-updated").textContent =
                    data.last_updated ? `Last updated: ${data.last_updated}` : "Last updated: --";

                // Loop through arrivals and update DOM
                for (let line in data.arrivals) {
                    for (let dest in data.arrivals[line]) {
                        const containerId = `${line}-${dest}`.replace(/\s+/g, '-'); // e.g. Red-Howard
                        const container = document.getElementById(containerId);
                        if (container) {
                            container.innerHTML = ""; // Clear old entries
                            data.arrivals[line][dest].forEach(train => {
                                const div = document.createElement("div");
                                div.className = "train-entry updated"; // Add highlight class

                                div.textContent = `${train.minutes} min (${train.status})`;
                                if (train.last_train) {
                                    div.textContent += " ğŸš‹ (Last Train)";
                                }
                                if (train.holiday_train) {
                                    div.textContent += " ğŸ„ (Holiday Train)";
                                }

                                container.appendChild(div);

                                // Remove highlight after 500ms
                                setTimeout(() => {
                                    div.classList.remove("updated");
                                }, 500);
                            });

                        }
                    }
                }

            } catch (err) {
                console.error("Error fetching arrivals:", err);
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            fetchArrivals();
            setInterval(fetchArrivals, 10000); // every 10 sec
        });
    </script>
</head>
<body>
    <h1>Wilson Station Train Tracker</h1>
    <div id="last-updated">
        {% if last_updated %}
            Last updated: {{ last_updated.strftime('%H:%M:%S') }}
        {% else %}
            Last updated: --
        {% endif %}
    </div>

    <div class="line-container">
        <h2>Red Line â€“ Howard</h2>
        <div id="Red-Howard">
            {% for train in arrivals["Red"]["Howard"] %}
                <div class="train-entry">
                    {{ train.minutes }} min ({{ train.status }})
                    {% if train.last_train %} ğŸš‹ (Last Train){% endif %}
                    {% if train.holiday_train %} ğŸ„ (Holiday Train){% endif %}
                </div>
            {% endfor %}
        </div>

        <h2>Red Line â€“ 95th</h2>
        <div id="Red-95th">
            {% for train in arrivals["Red"]["95th"] %}
                <div class="train-entry">
                    {{ train.minutes }} min ({{ train.status }})
                    {% if train.last_train %} ğŸš‹ (Last Train){% endif %}
                    {% if train.holiday_train %} ğŸ„ (Holiday Train){% endif %}
                </div>
            {% endfor %}
        </div>

        <h2>Purple Line â€“ Linden</h2>
        <div id="Purple-Linden">
            {% for train in arrivals["Purple"]["Linden"] %}
                <div class="train-entry">
                    {{ train.minutes }} min ({{ train.status }})
                    {% if train.last_train %} ğŸš‹ (Last Train){% endif %}
                    {% if train.holiday_train %} ğŸ„ (Holiday Train){% endif %}
                </div>
            {% endfor %}
        </div>

        <h2>Purple Line â€“ Loop</h2>
        <div id="Purple-Loop">
            {% for train in arrivals["Purple"]["Loop"] %}
                <div class="train-entry">
                    {{ train.minutes }} min ({{ train.status }})
                    {% if train.last_train %} ğŸš‹ (Last Train){% endif %}
                    {% if train.holiday_train %} ğŸ„ (Holiday Train){% endif %}
                </div>
            {% endfor %}
        </div>
    </div>
</body>
</html>
