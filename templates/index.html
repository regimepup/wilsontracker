<!DOCTYPE html>
<html>
<head>
    <title>Wilson Station Train Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <h1>
        {% set wilson_red = "Wil" %}
        {% set wilson_purple = "son" if arrivals["Purple"] else "" %}
        <span class="red-text">{{ wilson_red }}</span><span class="{% if wilson_purple %}purple-text{% else %}red-text{% endif %}">{{ wilson_purple if wilson_purple else 'son' }}</span>Tracker
    </h1>

    <!-- Visible timestamp -->
    <p id="last-updated" style="text-align:center; font-size:16px; margin-bottom:20px;">
        Loading...
    </p>

    <div class="container">
        <!-- Red Line Box -->
        <div id="redbox"></div>

        <!-- Purple Line Box -->
        <div id="purplebox"></div>
    </div>

    <script>
    const MAX_PER_DIRECTION = 2;

    function renderLineBox(line, elementId, directions, arrivals) {
        const container = document.getElementById(elementId);
        container.innerHTML = ""; // Clear previous

        directions.forEach(dir => {
            const innerBox = document.createElement("div");
            innerBox.className = "inner-box";

            const trains = arrivals[line][dir] || [];
            if (trains.length === 0) {
                const subBox = document.createElement("div");
                subBox.className = "sub-box";
                subBox.textContent = "Error finding arrivals";
                innerBox.appendChild(subBox);
            } else {
                trains.slice(0, MAX_PER_DIRECTION).forEach(train => {
                    const subBox = document.createElement("div");
                    subBox.className = "sub-box";
                    if (train.status === "Scheduled") subBox.classList.add("scheduled");
                    if (train.holiday_train) subBox.classList.add("holiday-train");
                    if (train.last_train) subBox.classList.add("last-train");

                    subBox.innerHTML = `<span class="stop-name">${dir}</span>
                                        <span class="arrival-time">${train.minutes} min${train.last_train ? ' (LAST TRAIN)' : ''}</span>`;
                    innerBox.appendChild(subBox);
                });
            }

            container.appendChild(innerBox);
        });
    }

    async function fetchArrivals() {
        try {
            const response = await fetch("/arrivals_json");
            const data = await response.json();

            // Update last updated
            const lastUpdatedDiv = document.getElementById("last-updated");
            lastUpdatedDiv.textContent = `Last updated: ${data.last_updated || 'Loading...'}`;

            // Render boxes
            renderLineBox("Red", "redbox", ["Howard","95th"], data.arrivals);
            renderLineBox("Purple", "purplebox", ["Linden","Loop"], data.arrivals);

        } catch (err) {
            console.error("Error fetching arrivals:", err);
        }
    }

    // Initial fetch
    fetchArrivals();

    // Repeat every 10 seconds
    setInterval(fetchArrivals, 10000);
    </script>
</body>
</html>
