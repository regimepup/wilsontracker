<!DOCTYPE html>
<html>
<head>
    <title>Wilson Station Train Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <h1>
        {% set wilson_red = "Wil" %}{% set wilson_purple = "son" if arrivals["Purple"] else "" %}
        <span class="red-text">{{ wilson_red }}</span><span class="{% if wilson_purple %}purple-text{% else %}red-text{% endif %}">{{ wilson_purple if wilson_purple else 'son' }}</span>Tracker

    </h1>

    <!-- Hidden timestamp for inspection in browser -->
    <div id="train-data" data-last-updated="{{ last_updated.strftime('%H:%M:%S') if last_updated else 'Loading...' }}" style="display:none;"></div>

    <div class="container">
        <!-- Red Line Box -->
        <div id="redbox">
            <div class="inner-container">
                <!-- Top Half: Howard -->
                <div class="inner-box">
                    {% if arrivals["Red"]["Howard"] %}
                        {% for train in arrivals["Red"]["Howard"] %}
                            <div class="sub-box
                                        {% if train.status == 'Scheduled' %} scheduled{% endif %}
                                        {% if train.holiday_train %} holiday-train{% endif %}">
                                <span class="stop-name">Howard</span>
                                <span class="arrival-time">
                                    {{ train.minutes }} min
                                    {% if train.last_train %}<span class="last-train"> (LAST TRAIN)</span>{% endif %}
                                </span>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="sub-box">Error finding arrivals</div>
                    {% endif %}
                </div>

                <!-- Bottom Half: 95th -->
                <div class="inner-box">
                    {% if arrivals["Red"]["95th"] %}
                        {% for train in arrivals["Red"]["95th"] %}
                            <div class="sub-box
                                        {% if train.status == 'Scheduled' %} scheduled{% endif %}
                                        {% if train.holiday_train %} holiday-train{% endif %}">
                                <span class="stop-name">95th</span>
                                <span class="arrival-time">
                                    {{ train.minutes }} min
                                    {% if train.last_train %}<span class="last-train"> (LAST TRAIN)</span>{% endif %}
                                </span>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="sub-box">Error finding arrivals</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Purple Line Box -->
        {% if arrivals["Purple"]["Linden"] or arrivals["Purple"]["Loop"] %}
        <div id="purplebox">
            <div class="inner-container">
                <!-- Top Half: Linden -->
                <div class="inner-box" id="Purple-Linden">
                    {% for train in arrivals["Purple"]["Linden"] %}
                        <div class="train-entry">
                            {{ train.minutes }} min ({{ train.status }})
                            {% if train.last_train %} üöã (Last Train){% endif %}
                            {% if train.holiday_train %} üéÑ (Holiday Train){% endif %}
                        </div>
                    {% endfor %}
                </div>

                <!-- Bottom Half: Loop -->
                <div class="inner-box" id="Purple-Loop">
                    {% for train in arrivals["Purple"]["Loop"] %}
                        <div class="train-entry">
                            {{ train.minutes }} min ({{ train.status }})
                            {% if train.last_train %} üöã (Last Train){% endif %}
                            {% if train.holiday_train %} üéÑ (Holiday Train){% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
<script>
async function updateArrivals() {
    try {
        const response = await fetch('/arrivals_json');
        const data = await response.json();

        // Update timestamp
        const lastUpdatedDiv = document.getElementById('train-data');
        if (lastUpdatedDiv) {
            lastUpdatedDiv.dataset.lastUpdated = data.last_updated;
        }

        // --- Hide purple box if no arrivals ---
        const purpleBox = document.getElementById('purplebox');
        if (purpleBox) {
            const hasPurpleArrivals = data.arrivals.Purple.Linden.length > 0 || data.arrivals.Purple.Loop.length > 0;
            purpleBox.style.display = hasPurpleArrivals ? 'block' : 'none';
        }

        // Helper function to build train HTML with emojis
        function buildTrainHTML(train, stopName) {
            const statusEmoji = train.status === 'Scheduled' ? '‚è∞' : 'üì∂'; // Clock for scheduled, wifi for tracked
            const holidayEmoji = train.holiday_train ? 'üéÑ' : '';
            const lastTrainEmoji = train.last_train ? 'üöã' : '';
            return `
                <div class="sub-box ${train.status === 'Scheduled' ? 'scheduled' : ''} ${train.holiday_train ? 'holiday-train' : ''}">
                    <span class="stop-name">${stopName}</span>
                    <span class="arrival-time">
                        ${train.minutes} min (${train.status} ${statusEmoji}) ${holidayEmoji} ${lastTrainEmoji}
                    </span>
                </div>
            `;
        }

        // --- Red Line Howard ---
        const redHowardContainer = document.querySelector('#redbox .inner-box:nth-child(1)');
        if (redHowardContainer) {
            redHowardContainer.innerHTML = '';
            const arrivals = data.arrivals.Red.Howard;
            if (arrivals.length === 0) {
                redHowardContainer.innerHTML = '<div class="sub-box">Error finding arrivals</div>';
            } else {
                arrivals.forEach(train => {
                    redHowardContainer.innerHTML += buildTrainHTML(train, 'Howard');
                });
            }
        }

        // --- Red Line 95th ---
        const red95Container = document.querySelector('#redbox .inner-box:nth-child(2)');
        if (red95Container) {
            red95Container.innerHTML = '';
            const arrivals = data.arrivals.Red["95th"];
            if (arrivals.length === 0) {
                red95Container.innerHTML = '<div class="sub-box">Error finding arrivals</div>';
            } else {
                arrivals.forEach(train => {
                    red95Container.innerHTML += buildTrainHTML(train, '95th');
                });
            }
        }

        // --- Purple Line Linden ---
        const purpleLindenContainer = document.querySelector('#purplebox .inner-box:nth-child(1)');
        if (purpleLindenContainer) {
            purpleLindenContainer.innerHTML = '';
            const arrivals = data.arrivals.Purple.Linden;
            if (arrivals.length === 0) {
                purpleLindenContainer.innerHTML = '<div class="sub-box">Error finding arrivals</div>';
            } else {
                arrivals.forEach(train => {
                    purpleLindenContainer.innerHTML += buildTrainHTML(train, 'Linden');
                });
            }
        }

        // --- Purple Line Loop ---
        const purpleLoopContainer = document.querySelector('#purplebox .inner-box:nth-child(2)');
        if (purpleLoopContainer) {
            purpleLoopContainer.innerHTML = '';
            const arrivals = data.arrivals.Purple.Loop;
            if (arrivals.length === 0) {
                purpleLoopContainer.innerHTML = '<div class="sub-box">Error finding arrivals</div>';
            } else {
                arrivals.forEach(train => {
                    purpleLoopContainer.innerHTML += buildTrainHTML(train, 'Loop');
                });
            }
        }

    } catch (err) {
        console.error('Error fetching arrivals:', err);
    }
}

// Initial load
updateArrivals();

// Update every 10 seconds
setInterval(updateArrivals, 10000);
</script>



</body>
</html>